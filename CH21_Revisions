-- This query extracts data for the tutorial in the clinical data analytics book chapter. Only the first icu stays from adult patients are extracted.


create or replace view static_data as
(select icud.subject_id,
        icud.hadm_id,
        icud.icustay_id, 
        case
         when (extract(day from icud.intime-dp.dob)) > 150 then 91.4
         else round((extract(day from icud.intime-dp.dob)),1)
        end as icustay_admit_age,
        dp.gender, 
        dd.admission_type as admission_type,
        case
         when icud.FIRST_CAREUNIT='FICU' then 'MICU'
         else icud.FIRST_CAREUNIT
        end as icustay_first_service,
        case
         when dd.hospital_expire_flag='Y' or dp.dod-icud.outtime < 30 then 'Y'     
         else 'N'
        end as thirty_day_mort
 from mimiciiiv13.icustays icud
 left join mimiciiiv13.admissions dd on icud.hadm_id=dd.hadm_id
 left join mimiciiiv13.patients dp on icud.subject_id=dp.subject_id
 where (extract(day from icud.intime-dp.dob)) > 17.999    
	#this is where the icu_stay_seq went, but not sure how to update -- (select * from icustays i1, icustays i2 
		#where not(i1.icustay_id = i2.icustay_id) and i1.subject_id = i2.subject_id
        #group by subject_id
        #having min(intime)
   and icud.icustay_id is not null
);
select * from static_data;

#-----------------------------
#--- BEGIN EXTRACTION OF LABS
#-----------------------------
create or replace view small_labevents as
(select HADM_ID, #replaced icustay_id here since that is not in labevents table anymore- not sure b/c then messes up next bit        
        itemid,
        charttime,
        valuenum
 from mimiciiiv13.labevents l
 where itemid in (50912,50971,50983,50902,50882,51221,51300,50931,50960,50893,50970,50954)
   and hadm_id in (select hadm_id from static_data) 
   and valuenum is not null
);
select * from small_labevents;

create or replace view labs_raw as
(select distinct hadm_id,        
        itemid,
        first_value(valuenum) over (partition by hadm_id, itemid order by charttime) as 'first_value'
        # can't get previous line to work without '', but that makes next section not work :(
 from small_labevents 
);
select * from labs_raw;

#runs until here. think that my pivot doesn't work because this makes first_value not a variable and pivot section references it
        #I could be wrong and just wrote my pivot wrong, but maybe someone should try to rewrite this pivot too and we can see
        #if I just did it wrong... like a lot... I tried to change order and stuff a couple times, but nothing worked for me :/
, labs as
(select *
 from (select * from labs_raw)
      pivot
      (sum(round(first_value,1)) as admit       
       for itemid in 
       ('50912' as cr, 
        '50971' as k,
        '50983' as na,
        '50902' as cl,
        '50882' as bicarb,
        '51221' as hct,
        '51300' as wbc,
        '50931' as glucose,
        '50960' as mg,
        '50893' as ca,
        '50970' as p,
        '50954' as lactate
       )
      )
)
--select * from labs;
------------------------------
--- END OF EXTRACTION OF LABS
------------------------------

------------------------------------
--- BEGIN EXTRACTION OF VITALS
------------------------------------
, small_chartevents as
(select icustay_id,
        case
         when itemid in (211) then 'hr'
         when itemid in (52,456) then 'map'  -- invasive and noninvasive measurements are combined
         when itemid in (51,455) then 'sbp'  -- invasive and noninvasive measurements are combined
         when itemid in (678,679) then 'temp'  -- in Fahrenheit
         when itemid in (646) then 'spo2'     
         when itemid in (618) then 'rr'
        end as type,                
        charttime,
        value1num
 from mimiciiiv13.chartevents l
 where itemid in (211,51,52,455,456,678,679,646,618)
   and icustay_id in (select icustay_id from static_data) 
   and value1num is not null
)
--select * from small_chartevents;

, vitals_raw as
(select distinct icustay_id,        
        type,
        first_value(value1num) over (partition by icustay_id, type order by charttime) as first_value
 from small_chartevents 
)
--select * from vitals_raw;

, vitals as
(select *
 from (select * from vitals_raw)
      pivot
      (sum(round(first_value,1)) as admit
       for type in 
       ('hr' as hr,
        'map' as map,
        'sbp' as sbp,
        'temp' as temp,
        'spo2' as spo2,
        'rr' as rr
       )
      )
)
--select * from vitals;
------------------------------------
--- END OF EXTRACTION OF VITALS
------------------------------------

-- Assemble final data
, final_data as
(select s.*,
        v.hr_admit,
        v.map_admit,
        v.sbp_admit,
        v.temp_admit,
        v.spo2_admit,       
        v.rr_admit,       
        l.cr_admit, 
        l.k_admit,
        l.na_admit,
        l.cl_admit,
        l.bicarb_admit,
        l.hct_admit,
        l.wbc_admit,
        l.glucose_admit,
        l.mg_admit,
        l.ca_admit,
        l.p_admit,
        l.lactate_admit
 from static_data s
 left join vitals v on s.icustay_id=v.icustay_id 
 left join labs l on s.icustay_id=l.icustay_id 
)
select * from final_data order by 1,2,3;
